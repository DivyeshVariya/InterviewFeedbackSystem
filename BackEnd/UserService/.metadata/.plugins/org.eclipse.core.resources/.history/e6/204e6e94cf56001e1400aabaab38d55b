package com.userService.serviceImpl;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.client.MultipartBodyBuilder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.reactive.function.BodyInserter;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.client.WebClient;

import com.userService.dto.FeedbackFileRequestDto;
import com.userService.dto.FeedbackFormRequestDto;
import com.userService.dto.ForgetPasswordResponseDto;
import com.userService.dto.ResponseDto;
import com.userService.service.CandidateFeedbackManagerService;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
@Service
public class CandidateFeedbackManagerServiceImpl implements CandidateFeedbackManagerService{

	@Autowired
	WebClient webclient;
	
	@Value("${temp.jwt.token}")
	String token;
	
	private Logger logger=LoggerFactory.getLogger(CandidateFeedbackManagerServiceImpl.class);
	
	@Override
	public ResponseDto handleFeedbackForm(FeedbackFormRequestDto feedbackFormRequestDto) {
		// TODO Auto-generated method stub
		logger.info(token);
		ResponseDto response=webclient.post()
				.uri("http://localhost:8083/feedbackManager/handle-feedback-form")
				.header(HttpHeaders.AUTHORIZATION,"Bearer "+token)
				.contentType(MediaType.APPLICATION_JSON)
				.accept(MediaType.APPLICATION_JSON)
				.bodyValue(feedbackFormRequestDto)
				.retrieve()
				.bodyToMono(ResponseDto.class)
				.block();
		logger.info(response.toString());
		return response;
	}

	@Override
	public ResponseDto handleFeedbackDocument(MultipartFile feedbackFile, String interviewerName, String interviewerDesignation) {
		// TODO Auto-generated method stub	
		MultipartBodyBuilder builder = new MultipartBodyBuilder();
		builder.part("feedbackFile",feedbackFile);
//		var payload=builder.build();
		webclient=WebClient.builder().baseUrl("http://localhost:8083/feedbackManager").build();
		logger.info(token);
		ResponseDto response=webclient
				.post()
				.uri(uriBuilder->uriBuilder
						.path("/handle-feedback-document")
						.queryParam("interviewerName",interviewerName)
						.queryParam("interviewerDesignation", interviewerDesignation)
						.build())
				.header(HttpHeaders.AUTHORIZATION,"Bearer "+token)
				.contentType(MediaType.MULTIPART_FORM_DATA_VALUE)
				.body(BodyInserters.fromMultipartData(builder.build()))
				.retrieve()
				.bodyToMono(ResponseDto.class)
				.block();
		logger.info(response.toString());
		return response;
	}

		
}
